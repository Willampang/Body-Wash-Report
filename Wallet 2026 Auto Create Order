//Auto Create Order
function formatBirthday(birthday) {
  if (!birthday) return "";
  
  try {
    var date;
    if (birthday instanceof Date) {
      date = birthday;
    } else {
      date = new Date(birthday);
    }
    
    if (isNaN(date.getTime())) {
      return String(birthday); // Return original if not a valid date
    }
    
    // Format as readable date without time
    var options = { year: 'numeric', month: 'long', day: 'numeric' };
    return date.toLocaleDateString('en-US', options);
  } catch (e) {
    return String(birthday); // Return original if formatting fails
  }
}

function onNewRow(e) {
  var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  if (!spreadsheet) return;
  
  var sheet = spreadsheet.getSheetByName("Sheet1");
  if (!sheet) sheet = spreadsheet.getSheets()[0];
  if (!sheet) return;
  
  var row;
  if (e && e.range) {
    row = e.range.getRow();
  } else {
    var lastRow = sheet.getLastRow();
    if (lastRow <= 1) return;
    row = lastRow;
  }
  if (row === 1) return;
  
  var name = "";
  var email = "";
  var streetAddress = "";
  var city = "";
  var state = "";
  var country = "";
  var postalCode = "";
  var phone = "";
  var qtyä¸°ç››æ¬¾ = 0;
  var qtyå¯Œè±ªæ¬¾ = 0;
  var qtyå¸é‡‘æ¬¾ = 0;
  
  try {
    name = sheet.getRange(row, 1).getValue();           // Col A: Name
    email = sheet.getRange(row, 2).getValue();          // Col B: Email  
    streetAddress = sheet.getRange(row, 3).getValue();  // Col C: Street Address
    city = sheet.getRange(row, 4).getValue();           // Col D: City
    state = sheet.getRange(row, 5).getValue();          // Col E: State
    country = sheet.getRange(row, 6).getValue();        // Col F: Country
    postalCode = sheet.getRange(row, 7).getValue();     // Col G: Postal Code
    phone = sheet.getRange(row, 8).getValue();          // Col H: Phone
    qtyä¸°ç››æ¬¾ = sheet.getRange(row, 9).getValue();       // Col I: ä¸°ç››æ¬¾
    qtyå¯Œè±ªæ¬¾ = sheet.getRange(row, 10).getValue();      // Col J: å¯Œè±ªæ¬¾
    qtyå¸é‡‘æ¬¾ = sheet.getRange(row, 11).getValue();      // Col K: å¸é‡‘æ¬¾
  } catch (error) {
    sheet.getRange(row, 12).setValue("Read Error: " + error.message);
    return;
  }
  
  name = name ? String(name).trim() : "";
  email = email ? String(email).trim() : "";
  streetAddress = streetAddress ? String(streetAddress).trim() : "";
  city = city ? String(city).trim() : "";
  state = state ? String(state).trim() : "";
  country = country ? String(country).trim() : "";
  postalCode = postalCode ? String(postalCode).trim() : "";
  phone = phone ? String(phone).trim() : "";
  
  qtyä¸°ç››æ¬¾ = Number(qtyä¸°ç››æ¬¾) || 0;
  qtyå¯Œè±ªæ¬¾ = Number(qtyå¯Œè±ªæ¬¾) || 0;
  qtyå¸é‡‘æ¬¾ = Number(qtyå¸é‡‘æ¬¾) || 0;
  
  if (!name) {
    sheet.getRange(row, 12).setValue("Error: No name");
    return;
  }

  if (!email) {
    sheet.getRange(row, 12).setValue("Error: No email provided");
    return;
  }

  if (qtyä¸°ç››æ¬¾ <= 0 && qtyå¯Œè±ªæ¬¾ <= 0 && qtyå¸é‡‘æ¬¾ <= 0) {
    sheet.getRange(row, 12).setValue("No products ordered");
    return;
  }

  // ğŸ” NEW LOGIC: Skip birthday check if å¯Œè±ªæ¬¾ qty is exactly 1
  var skipBirthdayCheck = (qtyå¯Œè±ªæ¬¾ === 1);
  var customerEmails = [];
  var customerBirthdays = [];
  var emailFoundInBirthdaySheet = true; // Default to true when skipping check
  
  if (!skipBirthdayCheck) {
    // Original birthday sheet check logic
    emailFoundInBirthdaySheet = false;
    
    var birthdaySheet = spreadsheet.getSheetByName("é¡¾å®¢ç”Ÿæ—¥");
    if (!birthdaySheet) {
      sheet.getRange(row, 12).setValue("Error: é¡¾å®¢ç”Ÿæ—¥ sheet not found");
      return;
    }
    
    var bLastRow = birthdaySheet.getLastRow();
    if (bLastRow > 1) {
      var bData = birthdaySheet.getRange(2, 1, bLastRow - 1, 4).getValues(); 
      // Col1 = Email1, Col2 = Birthday1, Col3 = Email2, Col4 = Birthday2
      for (var i = 0; i < bData.length; i++) {
        var bEmail1 = bData[i][0] ? String(bData[i][0]).trim() : "";
        var bBirthday1 = bData[i][1];
        var bEmail2 = bData[i][2] ? String(bData[i][2]).trim() : "";
        var bBirthday2 = bData[i][3];
        
        // Check if the input email matches either email1 or email2
        if ((bEmail1 && bEmail1.toLowerCase() === email.toLowerCase()) || 
            (bEmail2 && bEmail2.toLowerCase() === email.toLowerCase())) {
          emailFoundInBirthdaySheet = true;
          
          // Collect all emails for this customer
          if (bEmail1) customerEmails.push(bEmail1);
          if (bEmail2) customerEmails.push(bEmail2);
          
          // Collect all birthdays and format them (remove time)
          if (bBirthday1) {
            var formattedBirthday1 = formatBirthday(bBirthday1);
            if (formattedBirthday1) customerBirthdays.push(formattedBirthday1);
          }
          if (bBirthday2) {
            var formattedBirthday2 = formatBirthday(bBirthday2);
            if (formattedBirthday2) customerBirthdays.push(formattedBirthday2);
          }
          break;
        }
      }
    }
    
    // âŒ STOP PROCESSING if email not found in é¡¾å®¢ç”Ÿæ—¥ sheet (only when not skipping check)
    if (!emailFoundInBirthdaySheet) {
      sheet.getRange(row, 12).setValue("Email not found in é¡¾å®¢ç”Ÿæ—¥ sheet - Order not created");
      return;
    }
  }

  var store = "fep4d0-5w.myshopify.com";   
  var token = "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";

  var customerId = null;
  var existingCustomer = null;
  if (email) {
    var searchUrl = "https://" + store + "/admin/api/2025-01/customers/search.json?query=email:" + encodeURIComponent(email);
    var searchOptions = {
      "method": "get",
      "headers": { "X-Shopify-Access-Token": token },
      "muteHttpExceptions": true
    };
    var searchResponse = UrlFetchApp.fetch(searchUrl, searchOptions);
    var searchData = JSON.parse(searchResponse.getContentText());
    if (searchData.customers && searchData.customers.length > 0) {
      existingCustomer = searchData.customers[0];
      customerId = existingCustomer.id;
    }
  }

  var lineItems = [];
  
  //need to change to actual é’±åŒ…,é’±ç§,é“œé’± actual price and Variant ID 
  var products = {
    "ä¸°ç››æ¬¾": { variant_id: 51863659675951, price: "496.00", title: "ä¸°ç››æ¬¾" },
    "å¯Œè±ªæ¬¾": { variant_id: 51863659774255, price: "397.00", title: "å¯Œè±ªæ¬¾" },
    "å¸é‡‘æ¬¾": { variant_id: 51863659807023, price: "196.00", title: "å¸é‡‘æ¬¾" },
    "2025é’±ç§": { variant_id: 51863659872559, price: "0.00", title: "2025 é’±ç§" },
    "å¤©åœ†åœ°æ–¹é“œé’±": { variant_id: 51863660167471, price: "0.00", title: "å¤©åœ†åœ°æ–¹é“œé’±" }
  };
  
  if (qtyä¸°ç››æ¬¾ > 0) {
    lineItems.push({
      "variant_id": products["ä¸°ç››æ¬¾"].variant_id,
      "quantity": qtyä¸°ç››æ¬¾
      // Removed price and title - these are auto-populated by Shopify for orders
    });
  }
  
  if (qtyå¯Œè±ªæ¬¾ > 0) {
    lineItems.push({
      "variant_id": products["å¯Œè±ªæ¬¾"].variant_id,
      "quantity": qtyå¯Œè±ªæ¬¾
      // Removed price and title - these are auto-populated by Shopify for orders
    });
  }
  
  if (qtyå¸é‡‘æ¬¾ > 0) {
    lineItems.push({
      "variant_id": products["å¸é‡‘æ¬¾"].variant_id,
      "quantity": qtyå¸é‡‘æ¬¾
      // Removed price and title - these are auto-populated by Shopify for orders
    });
  }

  if (qtyå¯Œè±ªæ¬¾ >= 2) {
    // Add 2025 é’±ç§
    lineItems.push({
      "variant_id": products["2025é’±ç§"].variant_id,
      "quantity": 1
    });
    
    // Add é“œé’± (Fixed reference)
    lineItems.push({
      "variant_id": products["å¤©åœ†åœ°æ–¹é“œé’±"].variant_id,
      "quantity": 1
    });
  }

  var customerData = {};
  if (customerId) {
    customerData = { "id": customerId };
  } else if (email) {
    customerData = { "email": email };
  }

  var noteText = "Customer: " + (name || "Name not provided");
  
  // Remove duplicate emails and filter out the main email from customer emails list
  var uniqueCustomerEmails = [];
  for (var j = 0; j < customerEmails.length; j++) {
    var customerEmail = customerEmails[j];
    if (customerEmail.toLowerCase() !== email.toLowerCase() && 
        uniqueCustomerEmails.indexOf(customerEmail) === -1) {
      uniqueCustomerEmails.push(customerEmail);
    }
  }
  
  // Add main email on new line
  if (email) {
    noteText += "\nEmail: " + email;
  }
  
  // Add additional customer emails on new line (if any, excluding main email)
  if (uniqueCustomerEmails.length > 0) {
    noteText += "\nAdditional Emails: " + uniqueCustomerEmails.join(", ");
  }
  
  // Add birthdays on new line (only if not skipped)
  if (!skipBirthdayCheck && customerBirthdays.length > 0) {
    noteText += "\nBirthdays: " + customerBirthdays.join(", ");
  }

  // Create order payload (NOT draft order)
  var payload = {
    "order": {
      "line_items": lineItems,
      "billing_address": {
        "first_name": name || "Customer",
        "last_name": "",
        "phone": phone || "",
        "address1": streetAddress || "N/A",
        "city": city || "Kuala Lumpur", 
        "province": state || "",
        "country": country || "Malaysia",
        "zip": postalCode || ""
      },
      "shipping_address": {
        "first_name": name || "Customer",
        "last_name": "",
        "phone": phone || "",
        "address1": streetAddress || "N/A",
        "city": city || "Kuala Lumpur",
        "province": state || "",
        "country": country || "Malaysia",
        "zip": postalCode || ""
      },
      "note": noteText,
      "tags": "On Hold,Google Sheet Import,GHL",
      "financial_status": "pending",
      "send_receipt": false,
      "send_fulfillment_receipt": false,
      "inventory_behaviour": "decrement_obeying_policy" // Important for orders
    }
  };

  // Add customer data if available
  if (Object.keys(customerData).length > 0) {
    payload.order.customer = customerData;
  }

  // Use orders endpoint
  var url = "https://" + store + "/admin/api/2025-01/orders.json";
  var options = {
    "method": "post",
    "headers": {
      "X-Shopify-Access-Token": token,
      "Content-Type": "application/json"
    },
    "payload": JSON.stringify(payload),
    "muteHttpExceptions": true
  };

  var response = UrlFetchApp.fetch(url, options);
  var responseCode = response.getResponseCode();
  var data = JSON.parse(response.getContentText());

  // Better error handling
  if (responseCode >= 200 && responseCode < 300 && data.order) {
    sheet.getRange(row, 12).setValue("Order Created: " + data.order.id);
  } else {
    var errorMsg = "Error (" + responseCode + "): ";
    if (data.errors) {
      errorMsg += JSON.stringify(data.errors);
    } else {
      errorMsg += response.getContentText();
    }
    sheet.getRange(row, 12).setValue(errorMsg);
    
    // Log full response for debugging
    console.log("Full API Response:", response.getContentText());
  }
}
