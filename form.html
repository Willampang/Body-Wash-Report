<!DOCTYPE html>
<html>
<head>
    <title>Daily Sales Report</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .main-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex: 0 0 500px;
        }
        .preview-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 600px;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        h3 {
            color: #555;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }
        .form-sections {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        .form-section {
            flex: 1;
            min-width: 200px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-row {
            display: flex;
            gap: 10px;
            align-items: end;
        }
        .form-row .form-group {
            flex: 1;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 20px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            font-size: 12px;
            margin-bottom: 20px;
        }
        
        /* Summary Preview Styles */
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 12px;
        }
        .summary-table th, .summary-table td {
            border: 1px solid #333;
            padding: 8px;
            text-align: center;
        }
        .summary-title {
            background-color: #f0f0f0;
            font-weight: bold;
            font-size: 14px;
        }
        .summary-date {
            background-color: #f0f0f0;
            font-size: 12px;
        }
        .fb-ad-header {
            background-color: #4a6741;
            color: white;
            font-weight: bold;
        }
        .fb-ad-row {
            background-color: #d9e5d6;
        }
        .organic-header {
            background-color: #bf9000;
            color: white;
            font-weight: bold;
        }
        .organic-row {
            background-color: #fff2cc;
        }
        .sales-header {
            background-color: #1c4587;
            color: white;
            font-weight: bold;
        }
        .sales-row {
            background-color: #cfe2f3;
        }
        
        .simple-summary {
            margin-top: 20px;
            border: 2px solid #333;
        }
        .simple-summary table {
            width: 100%;
            border-collapse: collapse;
        }
        .simple-summary th {
            background-color: #f4cccc;
            padding: 10px;
            border: 1px solid #333;
            font-weight: bold;
        }
        .simple-summary td {
            background-color: #f4cccc;
            padding: 10px;
            border: 1px solid #333;
            text-align: center;
        }
        
        .loading-indicator {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        @media (max-width: 1200px) {
            .main-container {
                flex-direction: column;
            }
            .form-container, .preview-container {
                flex: none;
                width: 100%;
            }
            .form-sections {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="form-container">
            <h1>Daily Sales Report</h1>
            
            <div class="message info">
                <strong>Note:</strong> Previous data is automatically loaded from Daily Report sheet when the page opens.
            </div>
            
            <form id="salesForm">
                <div class="form-sections">
                    <div class="form-section">
                        <h3>FB Ad (Messenger)</h3>
                        <div class="form-group">
                            <label for="fbEnquiry">Enquiry:</label>
                            <input type="number" id="fbEnquiry" name="fbEnquiry" value="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="fbWaiting">Waiting Payment:</label>
                            <input type="number" id="fbWaiting" name="fbWaiting" value="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="fbDrop">Drop:</label>
                            <input type="number" id="fbDrop" name="fbDrop" value="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="fbClosedCustomers">Closed (Customers):</label>
                            <input type="number" id="fbClosedCustomers" name="fbClosedCustomers" value="0" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fbClosedB3F1">B3F1 Sets Sold:</label>
                                <input type="number" id="fbClosedB3F1" name="fbClosedB3F1" value="0" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="fbClosedSingle">Single Bottles:</label>
                                <input type="number" id="fbClosedSingle" name="fbClosedSingle" value="0" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Organic</h3>
                        <div class="form-group">
                            <label for="organicEnquiry">Enquiry:</label>
                            <input type="number" id="organicEnquiry" name="organicEnquiry" value="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="organicWaiting">Waiting Payment:</label>
                            <input type="number" id="organicWaiting" name="organicWaiting" value="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="organicDrop">Drop:</label>
                            <input type="number" id="organicDrop" name="organicDrop" value="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="organicClosedCustomers">Closed (Customers):</label>
                            <input type="number" id="organicClosedCustomers" name="organicClosedCustomers" value="0" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="organicClosedB3F1">B3F1 Sets Sold:</label>
                                <input type="number" id="organicClosedB3F1" name="organicClosedB3F1" value="0" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="organicClosedSingle">Single Bottles:</label>
                                <input type="number" id="organicClosedSingle" name="organicClosedSingle" value="0" required>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button type="submit" id="submitBtn">Submit & Update Data</button>
            </form>
            
            <div id="message" class="message" style="display: none;"></div>
        </div>
        
        <div class="preview-container">
            <h2>Live Preview</h2>
            <div id="loadingIndicator" class="loading-indicator">Loading previous data from Daily Report...</div>
            <div id="summaryPreview" style="display: none;">
                <!-- Main Summary Table -->
                <table class="summary-table">
                    <tr>
                        <td colspan="6" class="summary-title">Mandarin Body Wash Daily Enquiry</td>
                    </tr>
                    <tr>
                        <td colspan="6" class="summary-date" id="previewDate"></td>
                    </tr>
                    <tr>
                        <td class="fb-ad-header">FB Ad (Messenger)</td>
                        <td class="fb-ad-header">+/-</td>
                        <td class="fb-ad-header">Total</td>
                        <td class="organic-header">Organic</td>
                        <td class="organic-header">+/-</td>
                        <td class="organic-header">Total</td>
                    </tr>
                    <tr>
                        <td class="fb-ad-row">Contact:</td>
                        <td class="fb-ad-row" id="fbEnquiryChange">+0</td>
                        <td class="fb-ad-row" id="fbEnquiryTotal">1254</td>
                        <td class="organic-row">Contact:</td>
                        <td class="organic-row" id="organicEnquiryChange">+0</td>
                        <td class="organic-row" id="organicEnquiryTotal">5</td>
                    </tr>
                    <tr>
                        <td class="fb-ad-row">Waiting Payment:</td>
                        <td class="fb-ad-row" id="fbWaitingChange">+0</td>
                        <td class="fb-ad-row" id="fbWaitingTotal">8</td>
                        <td class="organic-row">Waiting Payment:</td>
                        <td class="organic-row" id="organicWaitingChange">+0</td>
                        <td class="organic-row" id="organicWaitingTotal">0</td>
                    </tr>
                    <tr>
                        <td class="fb-ad-row">Drop:</td>
                        <td class="fb-ad-row" id="fbDropChange">+0</td>
                        <td class="fb-ad-row" id="fbDropTotal">7</td>
                        <td class="organic-row">Drop:</td>
                        <td class="organic-row" id="organicDropChange">+0</td>
                        <td class="organic-row" id="organicDropTotal">0</td>
                    </tr>
                    <tr>
                        <td class="fb-ad-row">Closed</td>
                        <td class="fb-ad-row" id="fbClosedCustomersChange">+0</td>
                        <td class="fb-ad-row" id="fbClosedCustomersTotal">34</td>
                        <td class="organic-row">Closed</td>
                        <td class="organic-row" id="organicClosedCustomersChange">+0</td>
                        <td class="organic-row" id="organicClosedCustomersTotal">5</td>
                    </tr>
                </table>
                
                <!-- Sales Summary -->
                <table class="summary-table">
                    <tr>
                        <td colspan="4" class="sales-header">Total Sales (RM)</td>
                        <td colspan="4" class="sales-header">Total Sales (RM)</td>
                    </tr>
                    <tr>
                        <td class="sales-row">Total B3F1 Set Order<br>( RM 487 / set )</td>
                        <td class="sales-row" id="fbSalesB3F1Change">+0</td>
                        <td class="sales-row" id="fbSalesB3F1Total">29</td>
                        <td class="sales-row" id="fbSalesB3F1Amount">13,636.00</td>
                        <td class="sales-row">Total B3F1 Set Order<br>( RM 487 / set )</td>
                        <td class="sales-row" id="organicSalesB3F1Change">+0</td>
                        <td class="sales-row" id="organicSalesB3F1Total">5</td>
                        <td class="sales-row" id="organicSalesB3F1Amount">2,435.00</td>
                    </tr>
                    <tr>
                        <td class="sales-row">Total Single Bottle<br>( RM 167 / bottle )</td>
                        <td class="sales-row" id="fbSalesSingleChange">+0</td>
                        <td class="sales-row" id="fbSalesSingleTotal">6</td>
                        <td class="sales-row" id="fbSalesSingleAmount">1,002.00</td>
                        <td class="sales-row">Total Single Bottle<br>( RM 167 / bottle )</td>
                        <td class="sales-row" id="organicSalesSingleChange">+0</td>
                        <td class="sales-row" id="organicSalesSingleTotal">0</td>
                        <td class="sales-row" id="organicSalesSingleAmount">0.00</td>
                    </tr>
                    <tr>
                        <td class="sales-row"><strong>Total Closed</strong><br><span id="fbClosedFormula">34(+0)/1254</span></td>
                        <td class="sales-row" id="fbClosedPercentage">2.71%</td>
                        <td class="sales-row"></td>
                        <td class="sales-row" id="fbTotalAmount"><strong>14,638.00</strong></td>
                        <td class="sales-row"><strong>Total Closed</strong><br><span id="organicClosedFormula">5(+0)/5</span></td>
                        <td class="sales-row" id="organicClosedPercentage">100.00%</td>
                        <td class="sales-row"></td>
                        <td class="sales-row" id="organicTotalAmount"><strong>2,435.00</strong></td>
                    </tr>
                </table>
                
                <!-- Simple Summary Table -->
                <div class="simple-summary">
                    <table>
                        <tr>
                            <th>Today (<span id="simpleDateHeader"></span>) 6:00PM</th>
                            <th>Total</th>
                        </tr>
                        <tr>
                            <td>Enquiry (<span id="simpleEnquiry">+0</span>)</td>
                            <td id="simpleEnquiryTotal">1259</td>
                        </tr>
                        <tr>
                            <td>Waiting Payment (<span id="simpleWaiting">+0</span>)</td>
                            <td id="simpleWaitingTotal">8</td>
                        </tr>
                        <tr>
                            <td>Drop (<span id="simpleDrop">+0</span>)</td>
                            <td id="simpleDropTotal">7</td>
                        </tr>
                        <tr>
                            <td>Closed (<span id="simpleClosed">+0</span>)</td>
                            <td id="simpleClosedTotal">39</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentBaseTotals = {
            fb: { enquiry: 1254, waiting: 8, drop: 7, closedCustomers: 34, closedB3F1: 29, closedSingle: 6 },
            organic: { enquiry: 5, waiting: 0, drop: 0, closedCustomers: 5, closedB3F1: 5, closedSingle: 0 }
        };

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, auto-loading data from Daily Report...');
            
            // Auto-load current totals from Daily Report sheet on page load
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(function(totals) {
                        currentBaseTotals = totals;
                        document.getElementById('loadingIndicator').style.display = 'none';
                        document.getElementById('summaryPreview').style.display = 'block';
                        updatePreview();
                        console.log('Auto-loaded current totals from Daily Report sheet');
                    })
                    .withFailureHandler(function(error) {
                        console.error('Failed to auto-load totals:', error);
                        document.getElementById('loadingIndicator').style.display = 'none';
                        document.getElementById('summaryPreview').style.display = 'block';
                        updatePreview(); // Use default values if load fails
                        
                        // Show error message
                        const messageDiv = document.getElementById('message');
                        messageDiv.className = 'message error';
                        messageDiv.textContent = 'Could not load previous data. Using default values.';
                        messageDiv.style.display = 'block';
                        
                        setTimeout(() => {
                            messageDiv.style.display = 'none';
                        }, 5000);
                    })
                    .getCurrentTotalsFromDailyReport();
            } else {
                // Demo mode
                setTimeout(() => {
                    document.getElementById('loadingIndicator').style.display = 'none';
                    document.getElementById('summaryPreview').style.display = 'block';
                    updatePreview();
                }, 1000);
            }
            
            // Add event listeners to all inputs
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', updatePreview);
                input.addEventListener('change', updatePreview);
            });
        });
        
        function updatePreview() {
            console.log('Updating preview...');
            const data = collectFormData();
            console.log('Collected data:', data);
            
            const today = new Date();
            const dateStr = today.getDate() + "/" + (today.getMonth() + 1);
            const fullDateStr = today.getDate() + "/" + (today.getMonth() + 1) + "/" + today.getFullYear();
            
            // Update date displays
            document.getElementById('previewDate').textContent = fullDateStr;
            document.getElementById('simpleDateHeader').textContent = dateStr;
            
            // Calculate changes for all fields
            const fbEnquiryChange = parseFloat(data.fbEnquiry || 0);
            const fbWaitingChange = parseFloat(data.fbWaiting || 0);
            const fbDropChange = parseFloat(data.fbDrop || 0);
            const fbClosedCustomersChange = parseFloat(data.fbClosedCustomers || 0);
            const fbClosedB3F1Change = parseFloat(data.fbClosedB3F1 || 0);
            const fbClosedSingleChange = parseFloat(data.fbClosedSingle || 0);

            const organicEnquiryChange = parseFloat(data.organicEnquiry || 0);
            const organicWaitingChange = parseFloat(data.organicWaiting || 0);
            const organicDropChange = parseFloat(data.organicDrop || 0);
            const organicClosedCustomersChange = parseFloat(data.organicClosedCustomers || 0);
            const organicClosedB3F1Change = parseFloat(data.organicClosedB3F1 || 0);
            const organicClosedSingleChange = parseFloat(data.organicClosedSingle || 0);
            
            // Update FB Ad section (GREEN TABLE)
            document.getElementById('fbEnquiryChange').textContent = formatChange(fbEnquiryChange);
            document.getElementById('fbEnquiryTotal').textContent = Math.max(0,currentBaseTotals.fb.enquiry + fbEnquiryChange);
            
            document.getElementById('fbWaitingChange').textContent = formatChange(fbWaitingChange);
            document.getElementById('fbWaitingTotal').textContent = Math.max(0,currentBaseTotals.fb.waiting + fbWaitingChange);
            
            document.getElementById('fbDropChange').textContent = formatChange(fbDropChange);
            document.getElementById('fbDropTotal').textContent = Math.max(0,currentBaseTotals.fb.drop + fbDropChange);
            
            // Green table shows CUSTOMERS who bought (not products sold)
            document.getElementById('fbClosedCustomersChange').textContent = formatChange(fbClosedCustomersChange);
            document.getElementById('fbClosedCustomersTotal').textContent = Math.max(0,currentBaseTotals.fb.closedCustomers + fbClosedCustomersChange);
            
            // Update Organic section (GREEN TABLE)
            document.getElementById('organicEnquiryChange').textContent = formatChange(organicEnquiryChange);
            document.getElementById('organicEnquiryTotal').textContent = Math.max(0,currentBaseTotals.organic.enquiry + organicEnquiryChange);
            
            document.getElementById('organicWaitingChange').textContent = formatChange(organicWaitingChange);
            document.getElementById('organicWaitingTotal').textContent = Math.max(0,currentBaseTotals.organic.waiting + organicWaitingChange);
            
            document.getElementById('organicDropChange').textContent = formatChange(organicDropChange);
            document.getElementById('organicDropTotal').textContent = Math.max(0,currentBaseTotals.organic.drop + organicDropChange);
            
            // Green table shows CUSTOMERS who bought (not products sold)
            document.getElementById('organicClosedCustomersChange').textContent = formatChange(organicClosedCustomersChange);
            document.getElementById('organicClosedCustomersTotal').textContent = Math.max(0,currentBaseTotals.organic.closedCustomers + organicClosedCustomersChange);
            
            // Calculate totals for BLUE TABLE (sales calculations) - PRODUCTS sold
            const fbTotalClosedB3F1 = currentBaseTotals.fb.closedB3F1 + fbClosedB3F1Change;
            const fbTotalClosedSingle = currentBaseTotals.fb.closedSingle + fbClosedSingleChange;
            
            const organicTotalClosedB3F1 = currentBaseTotals.organic.closedB3F1 + organicClosedB3F1Change;
            const organicTotalClosedSingle = currentBaseTotals.organic.closedSingle + organicClosedSingleChange;
            
            // Update BLUE TABLE (sales sections) - shows PRODUCTS sold
            const fbB3F1SalesAmount = fbTotalClosedB3F1 * 487;
            const fbSingleSalesAmount = fbTotalClosedSingle * 167;
            const fbTotalAmount = fbB3F1SalesAmount + fbSingleSalesAmount;

            document.getElementById('fbSalesB3F1Change').textContent = formatChange(fbClosedB3F1Change);
            document.getElementById('fbSalesB3F1Total').textContent = fbTotalClosedB3F1;
            document.getElementById('fbSalesB3F1Amount').textContent = fbB3F1SalesAmount.toLocaleString('en-MY', {minimumFractionDigits: 2});

            document.getElementById('fbSalesSingleChange').textContent = formatChange(fbClosedSingleChange);
            document.getElementById('fbSalesSingleTotal').textContent = fbTotalClosedSingle;
            document.getElementById('fbSalesSingleAmount').textContent = fbSingleSalesAmount.toLocaleString('en-MY', {minimumFractionDigits: 2});

            const organicB3F1SalesAmount = organicTotalClosedB3F1 * 487;
            const organicSingleSalesAmount = organicTotalClosedSingle * 167;
            const organicTotalAmount = organicB3F1SalesAmount + organicSingleSalesAmount;

            document.getElementById('organicSalesB3F1Change').textContent = formatChange(organicClosedB3F1Change);
            document.getElementById('organicSalesB3F1Total').textContent = organicTotalClosedB3F1;
            document.getElementById('organicSalesB3F1Amount').textContent = organicB3F1SalesAmount.toLocaleString('en-MY', {minimumFractionDigits: 2});

            document.getElementById('organicSalesSingleChange').textContent = formatChange(organicClosedSingleChange);
            document.getElementById('organicSalesSingleTotal').textContent = organicTotalClosedSingle;
            document.getElementById('organicSalesSingleAmount').textContent = organicSingleSalesAmount.toLocaleString('en-MY', {minimumFractionDigits: 2});

            // Calculate percentage using CLOSED CUSTOMERS vs total enquiries
            const fbTotalEnquiry = currentBaseTotals.fb.enquiry + fbEnquiryChange;
            const fbTotalClosedCustomers = currentBaseTotals.fb.closedCustomers + fbClosedCustomersChange;
            const fbClosedPercentage = fbTotalEnquiry > 0 
                ? ((fbTotalClosedCustomers / fbTotalEnquiry) * 100).toFixed(2) 
                : 0;

            const organicTotalEnquiry = currentBaseTotals.organic.enquiry + organicEnquiryChange;
            const organicTotalClosedCustomers = currentBaseTotals.organic.closedCustomers + organicClosedCustomersChange;
            const organicClosedPercentage = organicTotalEnquiry > 0 
                ? ((organicTotalClosedCustomers / organicTotalEnquiry) * 100).toFixed(2) 
                : 0;

            // Formula shows CLOSED CUSTOMERS, not B3F1 sets
            document.getElementById('fbClosedFormula').textContent = `${fbTotalClosedCustomers}(${formatChange(fbClosedCustomersChange)})/${fbTotalEnquiry}`;
            document.getElementById('fbClosedPercentage').textContent = fbClosedPercentage + "%";
            document.getElementById('fbTotalAmount').innerHTML = `<strong>${fbTotalAmount.toLocaleString('en-MY', {minimumFractionDigits: 2})}</strong>`;

            document.getElementById('organicClosedFormula').textContent = `${organicTotalClosedCustomers}(${formatChange(organicClosedCustomersChange)})/${organicTotalEnquiry}`;
            document.getElementById('organicClosedPercentage').textContent = organicClosedPercentage + "%";
            document.getElementById('organicTotalAmount').innerHTML = `<strong>${organicTotalAmount.toLocaleString('en-MY', {minimumFractionDigits: 2})}</strong>`;
            
            // Update simple summary table (combined totals from both FB and Organic)
            const totalEnquiryChange = fbEnquiryChange + organicEnquiryChange;
            const totalWaitingChange = fbWaitingChange + organicWaitingChange;
            const totalDropChange = fbDropChange + organicDropChange;
            const totalClosedCustomersChange = fbClosedCustomersChange + organicClosedCustomersChange;
            
            // Calculate current totals for simple summary
            const simpleEnquiryTotal = (currentBaseTotals.fb.enquiry + currentBaseTotals.organic.enquiry) + totalEnquiryChange;
            const simpleWaitingTotal = (currentBaseTotals.fb.waiting + currentBaseTotals.organic.waiting) + totalWaitingChange;
            const simpleDropTotal = (currentBaseTotals.fb.drop + currentBaseTotals.organic.drop) + totalDropChange;
            const simpleClosedTotal = (currentBaseTotals.fb.closedCustomers + currentBaseTotals.organic.closedCustomers) + totalClosedCustomersChange;
            
            document.getElementById('simpleEnquiry').textContent = formatChange(totalEnquiryChange);
            document.getElementById('simpleEnquiryTotal').textContent = simpleEnquiryTotal;
            
            document.getElementById('simpleWaiting').textContent = formatChange(totalWaitingChange);
            document.getElementById('simpleWaitingTotal').textContent = simpleWaitingTotal;
            
            document.getElementById('simpleDrop').textContent = formatChange(totalDropChange);
            document.getElementById('simpleDropTotal').textContent = simpleDropTotal;
            
            document.getElementById('simpleClosed').textContent = formatChange(totalClosedCustomersChange);
            document.getElementById('simpleClosedTotal').textContent = simpleClosedTotal;
                    
            console.log('Preview updated successfully');
        }
        
        function formatChange(value) {
            const num = parseFloat(value || 0); // Changed from parseInt to parseFloat
            if (num > 0) return "+" + num;
            if (num < 0) return num.toString();
            return "+0";
        }
        
        function collectFormData() {
            return {
                fbEnquiry: document.getElementById('fbEnquiry').value,
                fbWaiting: document.getElementById('fbWaiting').value,
                fbDrop: document.getElementById('fbDrop').value,
                fbClosedCustomers: document.getElementById('fbClosedCustomers').value,
                fbClosedB3F1: document.getElementById('fbClosedB3F1').value,
                fbClosedSingle: document.getElementById('fbClosedSingle').value,

                organicEnquiry: document.getElementById('organicEnquiry').value,
                organicWaiting: document.getElementById('organicWaiting').value,
                organicDrop: document.getElementById('organicDrop').value,
                organicClosedCustomers: document.getElementById('organicClosedCustomers').value,
                organicClosedB3F1: document.getElementById('organicClosedB3F1').value,
                organicClosedSingle: document.getElementById('organicClosedSingle').value,
            };
        }

        document.getElementById('salesForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            const messageDiv = document.getElementById('message');
            messageDiv.style.display = 'none';
            
            const formData = collectFormData();
            
            // For Google Apps Script integration
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                google.script.run
                    .withSuccessHandler(function(response) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit & Update Data';
                        
                        // Automatically reload the latest totals after successful submission
                        google.script.run
                            .withSuccessHandler(function(totals) {
                                currentBaseTotals = totals;
                                updatePreview();
                                console.log('Auto-reloaded totals after submission');
                            })
                            .getCurrentTotalsFromDailyReport();
                        
                        messageDiv.className = 'message success';
                        messageDiv.textContent = response.message || 'Data saved successfully!';
                        messageDiv.style.display = 'block';
                        
                        // Reset form inputs
                        document.getElementById('salesForm').reset();
                        const inputs = document.querySelectorAll('input[type="number"]');
                        inputs.forEach(input => input.value = '0');
                        updatePreview();
                        
                        // Hide message after 5 seconds
                        setTimeout(() => {
                            messageDiv.style.display = 'none';
                        }, 5000);
                    })
                    .withFailureHandler(function(error) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit & Update Data';
                        
                        messageDiv.className = 'message error';
                        messageDiv.textContent = 'Error: ' + error.message;
                        messageDiv.style.display = 'block';
                        
                        console.error('Error submitting data:', error);
                    })
                    .submitData(formData);
            } else {
                // Demo mode - simulate server behavior
                setTimeout(() => {
                    // Update local base totals for demo
                    currentBaseTotals.fb.enquiry += parseInt(formData.fbEnquiry || 0);
                    currentBaseTotals.fb.waiting += parseInt(formData.fbWaiting || 0);
                    currentBaseTotals.fb.drop += parseInt(formData.fbDrop || 0);
                    currentBaseTotals.fb.closedCustomers += parseInt(formData.fbClosedCustomers || 0);
                    currentBaseTotals.fb.closedB3F1 += parseInt(formData.fbClosedB3F1 || 0);
                    currentBaseTotals.fb.closedSingle += parseInt(formData.fbClosedSingle || 0);
                    
                    currentBaseTotals.organic.enquiry += parseInt(formData.organicEnquiry || 0);
                    currentBaseTotals.organic.waiting += parseInt(formData.organicWaiting || 0);
                    currentBaseTotals.organic.drop += parseInt(formData.organicDrop || 0);
                    currentBaseTotals.organic.closedCustomers += parseInt(formData.organicClosedCustomers || 0);
                    currentBaseTotals.organic.closedB3F1 += parseInt(formData.organicClosedB3F1 || 0);
                    currentBaseTotals.organic.closedSingle += parseInt(formData.organicClosedSingle || 0);
                    
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit & Update Data';
                    
                    messageDiv.className = 'message success';
                    messageDiv.textContent = 'Data saved successfully! (Demo mode)';
                    messageDiv.style.display = 'block';
                    
                    // Reset form inputs
                    document.getElementById('salesForm').reset();
                    const inputs = document.querySelectorAll('input[type="number"]');
                    inputs.forEach(input => input.value = '0');
                    updatePreview();
                    
                    // Hide message after 5 seconds
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 5000);
                }, 1000);
            }
        });
    </script>
</body>
</html>
